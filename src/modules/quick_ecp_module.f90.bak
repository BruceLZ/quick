!
!	quick_ecp_module.f90
!	new_quick
!
!	Created by Yipu Miao on 2/18/11.
!	Copyright 2011 University of Florida. All rights reserved.
!

!  ECP module written by Alessandro GENONI 03/12/2006
module quick_ecp_module
     implicit none

     integer, parameter :: mxproj=5,mxang=3
!
! Derived Parameters
!
     integer, parameter :: mxnnn=max(2*mxang+1,mxang+mxproj+1),&
                           mxprim=(mxang+1)*(mxang+2)/2,&
                           mxgout=mxprim*mxprim,&
                           lmax1=max(1,mxang+max(mxang,mxproj)),&
                           lfdim=lmax1+1,&                            
                           lmfdim=lfdim**2,&
                           lmxdim=(lmax1*(lmax1+2)*(lmax1+4)/3 *  (lmax1+3) +&
                                  (lmax1+2)**2 * (lmax1+4))/16,&
                           mc1dim=2*mxproj-1,&
                           len_dfac=3*lmax1+3,&
                           len_fac=mxproj*mxproj
!
     integer :: necprim,nbf12,itolecp
     double precision :: tolecp,thrshecp

     integer, dimension(:), allocatable   :: nelecp,lmaxecp,nlp,kvett
     double precision, dimension (:), allocatable :: clp,zlp,ecp_int,gout

     integer, dimension(:,:), allocatable :: kfirst,klast
!
     integer, dimension(:), allocatable   :: lf,lmf,lml,lmx,lmy,lmz
     integer, dimension(:,:), allocatable :: mc,mr 

     double precision, dimension(:), allocatable   :: zlm,dfac,dfaci,factorial
     double precision, dimension(:,:), allocatable :: flmtx,fprod


    contains
    
    Subroutine readecp
   !
   !********************************************************
   ! readecp
   !--------------------------------------------------------
   ! Subroutines to read ecp
   !
   !
   ! Alessandro GENONI 03/05/2007
   ! Subroutine to  read the Effective Core Potentials
   ! The total number of electrons and the nuclear charges are modified too
   !
   use quick_constants_module
   use quick_files_module
   use quick_molspec_module
   use quick_ecp_module

   implicit double precision(a-h,o-z)
   character(len=80) :: line
   character(len=2)  :: atom
   character(len=3)  :: pot
   integer, dimension(0:92) :: klmaxecp,kelecp,kprimecp
   logical, dimension(0:92) :: warn

   open(iecpfile,file=ecpfilename,status='old')

   iofile = 0
   necprim=0
   nelecp=0
   lmaxecp=0
   klmaxecp=0
   kelecp=0
   kprimecp=0
   warn=.true.

   ! Parse the file and find the sizes of arrays to allocate them in memory

   do while (iofile == 0)
      read(iecpfile,'(A80)',iostat=iofile) line
      read(line,*,iostat=io) atom,ii
      if (io == 0 .and. ii == 0) then
         do i=1,92
            if (symbol(i) == atom) then
               iat=i
               warn(i)=.false.
            end if
         end do
         read(iecpfile,'(A80)',iostat=iofile) line
         read(line,*,iostat=iatom) klmaxecp(iat),kelecp(iat)
         if (iatom == 0) then
            do while (iatom == 0)
               read(iecpfile,'(A80)',iostat=iofile) line
               read(line,*,iostat=iatom) iprim,pot
               if (iatom == 0) then
                  kprimecp(iat)=kprimecp(iat)+iprim
                  do i=1,iprim
                     read(iecpfile,'(A80)',iostat=iofile) line
                     read(line,*) n,c1,c2
                  end do
               end if
            end do
         end if
      end if
   end do

   rewind iecpfile

   do i=1,natom
      lmaxecp(i)=klmaxecp(quick_molspec%iattype(i))
      nelecp(i)=kelecp(quick_molspec%iattype(i))
      quick_molspec%chg(i)=quick_molspec%chg(i)-nelecp(i)
      necprim=necprim+kprimecp(quick_molspec%iattype(i))
      nelec=nelec-nelecp(i)
   end do

   !
   ! Allocation of the arrays whose dimensions depend on NECPRIM
   ! and of the arrays KFIRST and KLAST
   !
   allocate(clp(necprim))
   allocate(zlp(necprim))
   allocate(nlp(necprim))
   allocate(kfirst(mxproj+1,natom))
   allocate(klast(mxproj+1,natom))
   !
   ! Store the vectors CLP,NLP,ZLP,KFIRST,KLAST
   !
   clp=0
   nlp=0
   zlp=0
   kfirst=0
   klast=0
   !
   jecprim=0
   do i=1,natom
      iofile=0
      do while (iofile == 0)
         read(iecpfile,'(A80)',iostat=iofile) line
         read(line,*,iostat=io) atom,ii
         if (io == 0 .and. ii == 0) then
            if (symbol(quick_molspec%iattype(i)) == atom) then
               iatom=0
               do while (iatom==0)
                  read(iecpfile,'(A80)',iostat=iofile) line
                  read(line,*,iostat=iatom) klmax,nelecore
                  if (iatom == 0) then
                     jjcont=0
                     do while (iatom == 0)
                        read(iecpfile,'(A80)',iostat=iofile) line
                        read(line,*,iostat=iatom) iprim,pot
                        jjcont=jjcont+1
                        if (iatom == 0) then
                           kfirst(jjcont,i)=jecprim+1
                           do j=1,iprim
                              jecprim=jecprim+1
                              read(iecpfile,'(A80)',iostat=iofile) line
                              read(line,*) nlp(jecprim),zlp(jecprim),clp(jecprim)
                           end do
                           klast(jjcont,i)=jecprim
                        end if
                     end do
                  end if
               end do
            end if
         end if
      end do
      rewind iecpfile
      !
      ! Check if the selected ECP exists for each atom in the molecule
      !
      if (warn(quick_molspec%iattype(i))) then
         write(ioutfile,'("  ")')
         write(ioutfile,'("WARNING: NO ECP FOR ATOM ",A2,I4)') symbol(quick_molspec%iattype(i)),i
      end if
      !
   end do

   return
end subroutine

end module quick_ecp_module
